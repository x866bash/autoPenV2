<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Keamanan Domain Otomatis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .scan-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .results-container {
            margin-top: 20px;
        }

        .result-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .credential-found {
            background: #fff3cd;
            border-left-color: #ffc107;
            border: 1px solid #ffeaa7;
        }

        .credential-found h4 {
            color: #856404;
        }

        .vulnerability {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .vulnerability h4 {
            color: #721c24;
        }

        .sqlmap-result {
            background: #e8f4fd;
            border-left-color: #17a2b8;
        }

        .sqlmap-result h4 {
            color: #0c5460;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .scan-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .scan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .scan-item:last-child {
            border-bottom: none;
        }

        .bruteforce-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .bruteforce-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .service-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            position: relative;
        }

        .service-card.attacking {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .reporting-section {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .reporting-section h3 {
            color: #155724;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bruteforce-status {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .bruteforce-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-text {
            font-size: 14px;
            color: #495057;
        }

        .wordlist-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }

        .sqlmap-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }

            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Scanner Keamanan Domain Otomatis</h1>
            <p>Platform pentesting otomatis dengan teknologi Hydra bruteforce user dan password</p>
        </div>

        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Peringatan:</strong> Tool ini hanya untuk tujuan edukasi dan pengujian pada sistem yang Anda miliki. 
            Penggunaan pada sistem tanpa izin adalah ilegal dan dapat melanggar hukum.
        </div>

        <div class="grid">
            <div class="card">
                <h2>üéØ Mulai Scan Keamanan</h2>
                <form class="scan-form" id="scanForm">
                    <div class="form-group">
                        <label for="target">Target Domain/IP:</label>
                        <input type="text" id="target" name="target" placeholder="example.com atau 192.168.1.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="scanType">Tipe Scan:</label>
                        <select id="scanType" name="scanType">
                            <option value="full">Full Scan (Lengkap)</option>
                            <option value="port">Port Scan (Nmap)</option>
                            <option value="subdomain">Subdomain Enumeration</option>
                            <option value="vulnerability">Vulnerability Scan</option>
                            <option value="sqlmap">SQLMap Attack (SQL Injection ada di autoPenV3)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <span id="scanButtonText">üöÄ Mulai Scan</span>
                        <span id="scanLoading" class="loading" style="display: none;"></span>
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>üìä Status Scan</h2>
                <div id="scanStatus">
                    <p>Belum ada scan yang berjalan</p>
                </div>
                
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0%</p>
                </div>
            </div>
        </div>

        <div class="card" id="bruteforceSection" style="display: none;">
            <div class="bruteforce-section">
                <h3>üîì Brute Force Login Attack (Hydra)</h3>
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Info:</strong> Fitur ini akan mencoba kombinasi username/password dari SecLists pada layanan yang terdeteksi.
                    Proses ini dapat memakan waktu beberapa menit.
                </div>
                
                <div class="service-grid" id="serviceGrid">
                    <!-- Services will be populated here -->
                </div>

                <!-- Brute Force Status Display -->
                <div id="bruteforceStatusContainer" style="display: none;">
                    <div class="bruteforce-status">
                        <h4>üîÑ Status Brute Force Attack</h4>
                        <div id="bruteforceStatusList">
                            <!-- Active brute force attacks will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <h2>üìã Hasil Scan</h2>
            <div id="scanResults" class="results-container">
                <!-- Results will be populated here -->
            </div>

            <!-- Reporting Section -->
            <div class="reporting-section" id="reportingSection" style="display: none;">
                <h3>üìÑ Reporting & Export</h3>
                <p style="margin-bottom: 15px;">Simpan hasil scanning dalam berbagai format untuk dokumentasi dan analisis lebih lanjut:</p>
                
                <div class="export-buttons">
                    <button class="btn btn-success btn-sm" onclick="exportResults('txt')">
                        üìÑ Export TXT
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportResults('csv')">
                        üìä Export CSV
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="exportResults('json')">
                        üîß Export JSON
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="printResults()">
                        üñ®Ô∏è Print Report
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìö Riwayat Scan</h2>
            <div id="scanHistory" class="scan-history">
                <p>Belum ada riwayat scan</p>
            </div>
        </div>
    </div>

    <script>
        let currentScanId = null;
        let scanInterval = null;
        let currentScanResults = null;
        let activeBruteforceAttacks = {};

        // Use the correct API base URL for port 8001
        const API_BASE = window.location.origin.replace(':8000', ':8001');

        document.getElementById('scanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const target = document.getElementById('target').value;
            const scanType = document.getElementById('scanType').value;
            
            console.log('Starting scan for:', target, 'Type:', scanType);
            
            // Show loading state
            document.getElementById('scanButtonText').style.display = 'none';
            document.getElementById('scanLoading').style.display = 'inline-block';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target: target,
                        scan_type: scanType
                    })
                });
                
                const result = await response.json();
                console.log('Scan started:', result);
                
                if (response.ok) {
                    currentScanId = result.scan_id;
                    startPolling();
                    updateScanHistory();
                } else {
                    alert('Error: ' + result.detail);
                }
            } catch (error) {
                console.error('Scan error:', error);
                alert('Error: ' + error.message);
            } finally {
                // Reset button state
                document.getElementById('scanButtonText').style.display = 'inline';
                document.getElementById('scanLoading').style.display = 'none';
            }
        });

        function startPolling() {
            if (scanInterval) clearInterval(scanInterval);
            
            scanInterval = setInterval(async () => {
                if (!currentScanId) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/v1/scan/${currentScanId}/status`);
                    const data = await response.json();
                    
                    console.log('Scan status:', data);
                    updateScanStatus(data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(scanInterval);
                        if (data.status === 'completed') {
                            // Get full results
                            const resultsResponse = await fetch(`${API_BASE}/api/v1/scan/${currentScanId}/results`);
                            const fullResults = await resultsResponse.json();
                            console.log('Full results:', fullResults);
                            currentScanResults = fullResults;
                            
                            displayResults(fullResults.results);
                            showBruteforceOptions(fullResults.results);
                            showReportingSection();
                        }
                        updateScanHistory();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function updateScanStatus(data) {
            const statusElement = document.getElementById('scanStatus');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            let statusClass = 'status-running';
            if (data.status === 'completed') statusClass = 'status-completed';
            if (data.status === 'failed') statusClass = 'status-failed';
            
            statusElement.innerHTML = `
                <p><strong>Target:</strong> ${data.target}</p>
                <p><strong>Tipe Scan:</strong> ${data.scan_type}</p>
                <p><strong>Status:</strong> <span class="status ${statusClass}">${data.status}</span></p>
            `;
            
            if (data.status === 'running') {
                progressContainer.style.display = 'block';
                progressFill.style.width = '50%';
                progressText.textContent = '50%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function displayResults(results) {
            console.log('Displaying results:', results);
            const resultsCard = document.getElementById('resultsCard');
            const resultsContainer = document.getElementById('scanResults');
            
            resultsCard.style.display = 'block';
            resultsContainer.innerHTML = '';
            
            // Display different types of results
            Object.keys(results).forEach(key => {
                const result = results[key];
                console.log('Processing result:', key, result);
                
                if (!result || typeof result !== 'object') return;
                
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item';
                
                if (key === 'nmap_scan' && result.open_ports) {
                    console.log('Found nmap_scan with open_ports:', result.open_ports);
                    resultElement.innerHTML = `
                        <h4>üîç Port Scan (Nmap)</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Port Terbuka:</strong> ${result.open_ports.length}</p>
                        <ul>
                            ${result.open_ports.map(port => `<li>Port ${port.port} (${port.service})</li>`).join('')}
                        </ul>
                    `;
                } else if (key === 'subdomain_enum' && result.subdomains) {
                    resultElement.innerHTML = `
                        <h4>üåê Subdomain Enumeration</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Subdomain Ditemukan:</strong> ${result.count}</p>
                        <ul>
                            ${result.subdomains.slice(0, 10).map(sub => `<li>${sub}</li>`).join('')}
                            ${result.subdomains.length > 10 ? '<li>... dan lainnya</li>' : ''}
                        </ul>
                    `;
                } else if (key === 'vulnerability_scan') {
                    resultElement.className += ' vulnerability';
                    resultElement.innerHTML = `
                        <h4>üö® Vulnerability Scan</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Vulnerabilities:</strong> ${result.count || 0}</p>
                        ${result.vulnerabilities ? `<ul>${result.vulnerabilities.slice(0, 5).map(vuln => `<li>${vuln}</li>`).join('')}</ul>` : ''}
                    `;
                } else if (key === 'security_headers') {
                    resultElement.innerHTML = `
                        <h4>üõ°Ô∏è Security Headers</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Security Score:</strong> ${Math.round(result.security_score || 0)}%</p>
                        <p><strong>Missing Headers:</strong> ${result.missing_headers ? result.missing_headers.join(', ') : 'None'}</p>
                    `;
                } else if (key === 'sqlmap_attack') {
                    resultElement.className += ' sqlmap-result';
                    resultElement.innerHTML = `
                        <h4>üíâ SQLMap Attack Results</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Target:</strong> ${result.target}</p>
                        <p><strong>Subdomains Found:</strong> ${result.subdomains_found || 0}</p>
                        <p><strong>Alive Domains:</strong> ${result.alive_domains || 0}</p>
                        <p><strong>URLs Collected:</strong> ${result.urls_collected || 0}</p>
                        <p><strong>Parameter URLs:</strong> ${result.param_urls || 0}</p>
                        <p><strong>SQL Vulnerabilities:</strong> ${result.sqli_vulnerabilities?.vulnerabilities_found || 0}</p>
                        ${result.credentials_found?.plaintext_passwords?.length > 0 ? 
                            `<div class="alert alert-success">
                                <strong>üîë Credentials Found:</strong>
                                <ul>
                                    ${result.credentials_found.plaintext_passwords.map(cred => 
                                        `<li><strong>${cred.username}:${cred.password}</strong></li>`
                                    ).join('')}
                                </ul>
                            </div>` : ''
                        }
                        ${result.workflow_summary ? 
                            `<div class="sqlmap-details">
                                <strong>üìã Detailed Report:</strong><br>
                                <pre>${result.workflow_summary}</pre>
                            </div>` : ''
                        }
                    `;
                }
                
                if (resultElement.innerHTML) {
                    resultsContainer.appendChild(resultElement);
                }
            });
            
            // Display brute force results if any
            if (currentScanResults.brute_force_results) {
                currentScanResults.brute_force_results.forEach(bf => {
                    const bfElement = document.createElement('div');
                    bfElement.className = 'result-item credential-found';
                    
                    if (bf.credentials_found && bf.credentials_found.length > 0) {
                        bfElement.innerHTML = `
                            <h4>üîì Brute Force Results - ${bf.service.toUpperCase()}:${bf.port}</h4>
                            <p><strong>Status:</strong> ${bf.status}</p>
                            <p><strong>Credentials Found:</strong> ${bf.count}</p>
                            <ul>
                                ${bf.credentials_found.map(cred => `<li><strong>${cred.username}:${cred.password}</strong></li>`).join('')}
                            </ul>
                            <div class="wordlist-info">
                                <strong>Wordlist Source:</strong> ${bf.wordlist_source || 'SecLists (danielmiessler)'}<br>
                                <strong>Usernames Tested:</strong> ${bf.usernames_tested || 'N/A'} | 
                                <strong>Passwords Tested:</strong> ${bf.passwords_tested || 'N/A'}
                            </div>
                        `;
                    } else {
                        bfElement.innerHTML = `
                            <h4>üîì Brute Force Results - ${bf.service.toUpperCase()}:${bf.port}</h4>
                            <p><strong>Status:</strong> ${bf.status}</p>
                            <p>No credentials found with SecLists wordlists.</p>
                            <div class="wordlist-info">
                                <strong>Wordlist Source:</strong> ${bf.wordlist_source || 'SecLists (danielmiessler)'}<br>
                                <strong>Usernames Tested:</strong> ${bf.usernames_tested || 'N/A'} | 
                                <strong>Passwords Tested:</strong> ${bf.passwords_tested || 'N/A'}
                            </div>
                        `;
                    }
                    
                    resultsContainer.appendChild(bfElement);
                });
            }
        }

        function showBruteforceOptions(results) {
            console.log('=== BRUTE FORCE DEBUG ===');
            console.log('Checking brute force options for results:', results);
            const bruteforceSection = document.getElementById('bruteforceSection');
            const serviceGrid = document.getElementById('serviceGrid');
            
            // Only show brute force section for port scans or full scans
            if (!results.nmap_scan && !results.sqlmap_attack) {
                return;
            }
            
            bruteforceSection.style.display = 'block';
            
            // Extract open ports from nmap scan
            let openPorts = [];
            
            // Check multiple possible locations for open ports
            if (results.nmap_scan && results.nmap_scan.open_ports) {
                openPorts = results.nmap_scan.open_ports;
                console.log('‚úÖ Found open ports in nmap_scan:', openPorts);
            } else if (results.nmap && results.nmap.open_ports) {
                openPorts = results.nmap.open_ports;
                console.log('‚úÖ Found open ports in nmap:', openPorts);
            } else if (results.port_scan && results.port_scan.open_ports) {
                openPorts = results.port_scan.open_ports;
                console.log('‚úÖ Found open ports in port_scan:', openPorts);
            } else {
                console.log('‚ùå No structured open ports found, trying to parse raw output...');
                // Try to parse from nmap output if available
                const nmapOutput = results.nmap_scan?.output || results.nmap_scan?.raw_output || results.nmap?.output || results.nmap;
                console.log('Raw nmap output:', nmapOutput);
                
                if (typeof nmapOutput === 'string' && nmapOutput.includes('open')) {
                    console.log('üîç Parsing nmap output for open ports...');
                    const lines = nmapOutput.split('\n');
                    for (const line of lines) {
                        if (line.includes('/tcp') && line.includes('open')) {
                            console.log('Found open port line:', line);
                            const parts = line.trim().split(/\s+/);
                            const portPart = parts[0];
                            const servicePart = parts.length > 2 ? parts[2] : 'unknown';
                            const portNum = parseInt(portPart.split('/')[0]);
                            if (!isNaN(portNum)) {
                                openPorts.push({ port: portNum, service: servicePart });
                                console.log('‚úÖ Parsed port:', portNum, 'service:', servicePart);
                            }
                        }
                    }
                    console.log('‚úÖ Total parsed open ports:', openPorts);
                } else {
                    console.log('‚ùå No parseable nmap output found');
                }
            }
            
            console.log('Final open ports for brute force:', openPorts);
            
            if (openPorts.length > 0) {
                serviceGrid.innerHTML = '';
                
                // Common services that support brute force
                const supportedServices = {
                    22: 'ssh',
                    21: 'ftp',
                    23: 'telnet',
                    25: 'smtp',
                    110: 'pop3',
                    143: 'imap',
                    3389: 'rdp',
                    5432: 'postgres',
                    3306: 'mysql'
                };
                
                let servicesFound = 0;
                openPorts.forEach(port => {
                    console.log('Checking port:', port.port, 'Service mapping:', supportedServices[port.port]);
                    if (supportedServices[port.port]) {
                        servicesFound++;
                        const serviceCard = document.createElement('div');
                        serviceCard.className = 'service-card';
                        serviceCard.id = `service-${port.port}`;
                        serviceCard.innerHTML = `
                            <h4>${supportedServices[port.port].toUpperCase()}</h4>
                            <p>Port: ${port.port}</p>
                            <button class="btn btn-danger btn-sm" onclick="startBruteforce('${supportedServices[port.port]}', ${port.port})">
                                üîì Brute Force
                            </button>
                            <div class="wordlist-info">
                                Menggunakan wordlist dari SecLists
                            </div>
                        `;
                        serviceGrid.appendChild(serviceCard);
                        console.log('‚úÖ Created service card for:', supportedServices[port.port], 'on port', port.port);
                    }
                });
                
                console.log(`‚úÖ Created ${servicesFound} brute force service cards`);
                
                if (servicesFound === 0) {
                    serviceGrid.innerHTML = '<div class="alert alert-warning">Tidak ada layanan yang mendukung brute force ditemukan pada port yang terbuka.</div>';
                    console.log('‚ö†Ô∏è No supported services found for brute force');
                }
            } else {
                console.log('‚ùå No open ports found, showing debug info');
                // Show debug info
                serviceGrid.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üîç Debug Info:</strong><br>
                        No open ports detected for brute force.<br>
                        <strong>Available results keys:</strong> ${Object.keys(results).join(', ')}<br>
                        <strong>Raw results:</strong><br>
                        <pre style="font-size: 11px; max-height: 200px; overflow-y: auto;">${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `;
            }
            console.log('=== END BRUTE FORCE DEBUG ===');
        }

        function showReportingSection() {
            const reportingSection = document.getElementById('reportingSection');
            reportingSection.style.display = 'block';
        }

        function updateBruteforceStatus(service, port, status, progress = null) {
            const serviceCard = document.getElementById(`service-${port}`);
            const statusContainer = document.getElementById('bruteforceStatusContainer');
            const statusList = document.getElementById('bruteforceStatusList');
            
            if (status === 'running') {
                // Update service card
                if (serviceCard) {
                    serviceCard.classList.add('attacking');
                    serviceCard.innerHTML = `
                        <h4>${service.toUpperCase()}</h4>
                        <p>Port: ${port}</p>
                        <div class="bruteforce-progress">
                            <div class="loading"></div>
                            <span class="progress-text">Attacking...</span>
                        </div>
                        <div class="wordlist-info">
                            Menggunakan wordlist dari SecLists
                        </div>
                    `;
                }
                
                // Show status container
                statusContainer.style.display = 'block';
                
                // Add to status list
                const statusItem = document.createElement('div');
                statusItem.id = `status-${port}`;
                statusItem.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üîÑ ${service.toUpperCase()}:${port}</strong> - Brute force attack sedang berjalan...
                        <div class="bruteforce-progress">
                            <div class="loading"></div>
                            <span class="progress-text">Testing credentials from SecLists...</span>
                        </div>
                    </div>
                `;
                statusList.appendChild(statusItem);
                
            } else if (status === 'completed' || status === 'failed') {
                // Update service card
                if (serviceCard) {
                    serviceCard.classList.remove('attacking');
                    const statusClass = status === 'completed' ? 'success' : 'danger';
                    const statusText = status === 'completed' ? 'Selesai' : 'Gagal';
                    serviceCard.innerHTML = `
                        <h4>${service.toUpperCase()}</h4>
                        <p>Port: ${port}</p>
                        <div class="alert alert-${statusClass}">
                            ${statusText}
                        </div>
                        <div class="wordlist-info">
                            Wordlist dari SecLists telah digunakan
                        </div>
                    `;
                }
                
                // Remove from status list
                const statusItem = document.getElementById(`status-${port}`);
                if (statusItem) {
                    statusItem.remove();
                }
                
                // Hide status container if no more active attacks
                if (statusList.children.length === 0) {
                    statusContainer.style.display = 'none';
                }
            }
        }

        async function startBruteforce(service, port) {
            if (!currentScanId) {
                alert('No active scan found');
                return;
            }
            
            console.log('Starting brute force:', service, port);
            
            try {
                updateBruteforceStatus(service, port, 'running');
                
                const response = await fetch(`${API_BASE}/api/v1/scan/${currentScanId}/bruteforce?service=${service}&port=${port}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                console.log('Brute force started:', result);
                
                if (response.ok) {
                    // Start polling for brute force results
                    activeBruteforceAttacks[`${service}:${port}`] = true;
                    pollBruteforceResults(service, port);
                } else {
                    updateBruteforceStatus(service, port, 'failed');
                    alert('Error: ' + result.detail);
                }
            } catch (error) {
                console.error('Brute force error:', error);
                updateBruteforceStatus(service, port, 'failed');
                alert('Error: ' + error.message);
            }
        }

        function pollBruteforceResults(service, port) {
            const pollInterval = setInterval(async () => {
                if (!activeBruteforceAttacks[`${service}:${port}`]) {
                    clearInterval(pollInterval);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/v1/scan/${currentScanId}/results`);
                    const data = await response.json();
                    
                    if (data.brute_force_results) {
                        const bfResult = data.brute_force_results.find(bf => 
                            bf.service === service && bf.port === port
                        );
                        
                        if (bfResult && (bfResult.status === 'completed' || bfResult.status === 'failed')) {
                            activeBruteforceAttacks[`${service}:${port}`] = false;
                            updateBruteforceStatus(service, port, bfResult.status);
                            currentScanResults = data;
                            displayResults(data.results);
                            clearInterval(pollInterval);
                        }
                    }
                } catch (error) {
                    console.error('Error polling brute force results:', error);
                }
            }, 3000);
        }

        // Export functions
        function exportResults(format) {
            if (!currentScanResults) {
                alert('Tidak ada hasil scan untuk diekspor');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const target = currentScanResults.target || 'unknown';
            const filename = `scan_report_${target}_${timestamp}`;

            let content = '';
            let mimeType = '';

            switch (format) {
                case 'txt':
                    content = generateTxtReport(currentScanResults);
                    mimeType = 'text/plain';
                    break;
                case 'csv':
                    content = generateCsvReport(currentScanResults);
                    mimeType = 'text/csv';
                    break;
                case 'json':
                    content = JSON.stringify(currentScanResults, null, 2);
                    mimeType = 'application/json';
                    break;
            }

            downloadFile(content, `${filename}.${format}`, mimeType);
        }

        function generateTxtReport(data) {
            let report = '';
            report += '='.repeat(60) + '\n';
            report += '           LAPORAN HASIL SECURITY SCAN\n';
            report += '='.repeat(60) + '\n';
            report += `Target: ${data.target}\n`;
            report += `Tipe Scan: ${data.scan_type}\n`;
            report += `Status: ${data.status}\n`;
            report += `Waktu Scan: ${new Date().toLocaleString('id-ID')}\n`;
            report += '='.repeat(60) + '\n\n';

            // Port Scan Results
            if (data.results.nmap_scan) {
                report += 'üìç PORT SCAN RESULTS (NMAP)\n';
                report += '-'.repeat(40) + '\n';
                report += `Status: ${data.results.nmap_scan.status}\n`;
                if (data.results.nmap_scan.open_ports) {
                    report += `Port Terbuka: ${data.results.nmap_scan.open_ports.length}\n\n`;
                    data.results.nmap_scan.open_ports.forEach(port => {
                        report += `  - Port ${port.port} (${port.service})\n`;
                    });
                }
                report += '\n';
            }

            // SQLMap Results
            if (data.results.sqlmap_attack) {
                report += 'üíâ SQLMAP ATTACK RESULTS\n';
                report += '-'.repeat(40) + '\n';
                report += data.results.sqlmap_attack.workflow_summary || 'No detailed summary available';
                report += '\n\n';
            }

            // Add brute force results
            if (data.brute_force_results && data.brute_force_results.length > 0) {
                report += 'üîì BRUTE FORCE RESULTS (SecLists)\n';
                report += '-'.repeat(40) + '\n';
                data.brute_force_results.forEach(bf => {
                    report += `Service: ${bf.service.toUpperCase()}:${bf.port}\n`;
                    report += `Status: ${bf.status}\n`;
                    report += `Wordlist Source: ${bf.wordlist_source || 'SecLists'}\n`;
                    if (bf.credentials_found && bf.credentials_found.length > 0) {
                        report += `Credentials Found: ${bf.credentials_found.length}\n`;
                        bf.credentials_found.forEach(cred => {
                            report += `  - ${cred.username}:${cred.password}\n`;
                        });
                    } else {
                        report += 'No credentials found\n';
                    }
                    report += '\n';
                });
            }

            report += '='.repeat(60) + '\n';
            report += 'Report generated by Scanner Keamanan Domain Otomatis\n';
            report += 'Wordlists powered by SecLists (danielmiessler)\n';
            report += '='.repeat(60) + '\n';

            return report;
        }

        function generateCsvReport(data) {
            let csv = 'Type,Service,Port,Status,Details,Wordlist_Source,Timestamp\n';
            const timestamp = new Date().toISOString();

            // Port Scan Results
            if (data.results.nmap_scan && data.results.nmap_scan.open_ports) {
                data.results.nmap_scan.open_ports.forEach(port => {
                    csv += `"Port Scan","${port.service}","${port.port}","Open","Port ${port.port} is open","N/A","${timestamp}"\n`;
                });
            }

            // SQLMap Results
            if (data.results.sqlmap_attack) {
                const sqlmap = data.results.sqlmap_attack;
                csv += `"SQLMap Attack","SQL Injection","N/A","${sqlmap.status}","${sqlmap.sqli_vulnerabilities?.vulnerabilities_found || 0} vulnerabilities found","SecLists","${timestamp}"\n`;
            }

            // Brute Force Results
            if (data.brute_force_results) {
                data.brute_force_results.forEach(bf => {
                    if (bf.credentials_found && bf.credentials_found.length > 0) {
                        bf.credentials_found.forEach(cred => {
                            csv += `"Brute Force","${bf.service}","${bf.port}","Success","${cred.username}:${cred.password}","${bf.wordlist_source || 'SecLists'}","${timestamp}"\n`;
                        });
                    } else {
                        csv += `"Brute Force","${bf.service}","${bf.port}","No Results","No credentials found","${bf.wordlist_source || 'SecLists'}","${timestamp}"\n`;
                    }
                });
            }

            return csv;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function printResults() {
            if (!currentScanResults) {
                alert('Tidak ada hasil scan untuk dicetak');
                return;
            }

            const printContent = generateTxtReport(currentScanResults);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Scan Report - ${currentScanResults.target}</title>
                    <style>
                        body { font-family: monospace; white-space: pre-wrap; margin: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function updateScanHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/scans`);
                const data = await response.json();
                
                const historyElement = document.getElementById('scanHistory');
                
                if (data.scans && data.scans.length > 0) {
                    historyElement.innerHTML = data.scans.map(scan => `
                        <div class="scan-item">
                            <div>
                                <strong>${scan.target}</strong> (${scan.scan_type})
                                <br>
                                <small class="status status-${scan.status}">${scan.status}</small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteScan('${scan.scan_id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `).join('');
                } else {
                    historyElement.innerHTML = '<p>Belum ada riwayat scan</p>';
                }
            } catch (error) {
                console.error('Error updating scan history:', error);
            }
        }

        async function deleteScan(scanId) {
            if (confirm('Are you sure you want to delete this scan?')) {
                try {
                    const response = await fetch(`${API_BASE}/api/v1/scan/${scanId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        updateScanHistory();
                    } else {
                        alert('Error deleting scan');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Load scan history on page load
        updateScanHistory();
    </script>
</body>
</html>
